# ğŸ” TikTok API X-Bogus & Signature Requirements

## ğŸ¯ The Real Problem

After analyzing the actual TikTok API endpoint, we discovered why the HTTP scraper returns 0 videos:

**TikTok's API requires cryptographic signatures that are dynamically generated by JavaScript.**

## ğŸ“Š API Endpoint Analysis

### Example Real TikTok API Call:
```
https://www.tiktok.com/api/post/item_list/
  ?secUid=MS4wLjABAAAA...
  &cursor=0
  &count=16
  &msToken=iV2Bnnn5n5Z1S81X2NCDx5xkPynJll4N...
  &verifyFp=verify_mj4y2ots_qskgIuQ2_fNZC_45Qw...
  &X-Bogus=DFSzKIGuBFzANVwdCYOMcqkDy3Lv
  &X-Gnarly=MktlFPOvm8z1pwytwe5PzBqiTF4PV93N...
  + 50+ other parameters
```

### ğŸ”‘ Critical Missing Parameters:

1. **X-Bogus** (Required!)
   - Anti-bot signature
   - **Dynamically generated** by TikTok's JavaScript
   - Changes for every request
   - Algorithm is obfuscated and changes frequently

2. **X-Gnarly** (Required!)
   - Additional signature parameter
   - Also generated by JavaScript
   - Used for request validation

3. **msToken** (Required!)
   - From cookies
   - Session-specific token
   - Must match the logged-in session

4. **verifyFp** (Required!)
   - Browser fingerprint verification
   - Generated by TikTok's fingerprinting script

5. **device_id** (Required!)
   - Device identifier
   - Must be consistent with session

6. **50+ Browser Fingerprint Parameters**
   - `clientABVersions` - A/B test versions
   - `browser_*` - Browser details
   - `screen_*` - Screen dimensions
   - And many more...

---

## âŒ Why HTTP Scraper Fails

### Current HTTP Scraper:
```python
params = {
    "secUid": sec_uid,
    "count": 30,
    "cursor": 0
}
```

### TikTok's Response:
```json
{
  "statusCode": 0,
  "itemList": [],      â† Empty!
  "hasMore": false
}
```

**TikTok returns 200 OK but with empty video list because:**
- Missing X-Bogus signature
- Missing X-Gnarly signature  
- Missing msToken
- Missing verifyFp
- Missing device_id
- Missing dozens of fingerprint parameters

---

## ğŸ” X-Bogus Generation

### What is X-Bogus?

X-Bogus is a **cryptographic signature** generated by TikTok's obfuscated JavaScript that:

1. **Validates the request** came from a real browser
2. **Prevents API abuse** by bots
3. **Changes per request** based on:
   - Request parameters
   - Timestamp
   - User agent
   - Browser fingerprint
   - Session cookies

### How It's Generated:

```javascript
// Simplified (actual algorithm is obfuscated)
function generateXBogus(params, userAgent, timestamp, cookies) {
    // 1. Concatenate all parameters
    const paramString = Object.entries(params)
        .sort()
        .map(([k, v]) => `${k}=${v}`)
        .join('&');
    
    // 2. Add browser fingerprint
    const fingerprint = generateFingerprint();
    
    // 3. Hash with secret algorithm
    const hash = obfuscatedHash(paramString, fingerprint, timestamp);
    
    // 4. Encode
    return base64Encode(hash);
}
```

**The problem:** The actual algorithm is:
- Heavily obfuscated
- Embedded in minified JavaScript
- Changes frequently (anti-reverse-engineering)
- Requires browser environment to execute

---

## ğŸš« Why We Can't Generate X-Bogus in Python

### Attempts and Their Limitations:

1. **Reverse Engineering**
   - âŒ Algorithm is obfuscated
   - âŒ Changes every few weeks
   - âŒ Requires constant maintenance

2. **JavaScript Execution in Python**
   ```python
   # Using js2py, PyExecJS, etc.
   js_code = extract_tiktok_signature_function()
   result = execjs.eval(js_code)
   ```
   - âŒ TikTok's JS checks for real browser environment
   - âŒ Requires DOM, window, navigator objects
   - âŒ Still detectable as non-browser

3. **Third-Party Libraries**
   - Some exist but:
     - âŒ Quickly become outdated
     - âŒ May violate TikTok's ToS
     - âŒ Often don't work reliably

---

## âœ… What Works: Playwright

### Why Playwright Succeeds:

Playwright runs a **real browser** (Chromium) that:
- âœ… Executes TikTok's JavaScript naturally
- âœ… Generates valid X-Bogus signatures automatically
- âœ… Has real DOM, window, navigator objects
- âœ… Passes browser fingerprinting checks
- âœ… Handles cookies properly

### Flow:
```
Playwright â†’ Chromium â†’ TikTok.com
                â†“
         Executes JS
                â†“
    Generates X-Bogus automatically
                â†“
         Makes API call
                â†“
    Returns videos âœ…
```

---

## ğŸ¯ Current HTTP Scraper Capabilities

### âœ… What It CAN Do:

1. **Get Profile Information**
   - Works because profile is in initial HTML
   - No API call needed
   - ```
     âœ… Profile: Casey Kaspol - 7.4M followers
     ```

2. **Extract Videos from HTML State** (if present)
   - UNIVERSAL_DATA itemList
   - SIGI_STATE ItemModule
   - HTML link parsing
   - ```
     âœ… Found 30 videos in SIGI_STATE
     ```

### âŒ What It CANNOT Do:

1. **API Pagination**
   - Cannot generate X-Bogus
   - API returns empty list
   - ```
     âŒ API returned 0 videos
     ```

2. **Fetch Videos Beyond Initial Page**
   - Initial HTML may have 0-30 videos
   - API needed for more
   - Cannot use API without signatures

---

## ğŸ’¡ Solutions & Workarounds

### Option 1: Use Playwright (Recommended)

**Best for:**
- Reliable video fetching
- Pagination (1000s of videos)
- Long-term use

**Setup:**
1. Get a valid TikTok session cookie
2. Set `TIKTOK_COOKIE` in `.env`
3. Use `TIKTOK_HEADLESS=false` for better success
4. Consider residential proxy

**Expected Success Rate:**
- With cookie: 80-95%
- With cookie + proxy: 90-99%

### Option 2: Improve HTTP Scraper (Limited)

**What we've done:**
- âœ… Added SIGI_STATE support
- âœ… Added HTML link extraction
- âœ… Added comprehensive parameters to API call
- âœ… Better error messages

**Limitations:**
- âŒ Still cannot generate X-Bogus
- âŒ API will return 0 videos
- âœ… May get 0-30 videos from HTML states

**Use cases:**
- Quick profile checks
- Fallback when Playwright fails
- Getting first few videos only

### Option 3: Third-Party Services

**Commercial APIs:**
- Apify TikTok Scraper
- Bright Data TikTok API
- ScrapingBee TikTok API

**Pros:**
- âœ… Handle signatures for you
- âœ… Manage proxies
- âœ… Better success rates

**Cons:**
- âŒ Cost money
- âŒ Rate limits
- âŒ May still violate TikTok ToS

### Option 4: Hybrid Approach (Current Implementation)

**What your scraper does:**

1. **Try Playwright first** (with retries)
   - Generates signatures automatically
   - High success rate
   
2. **If Playwright fails, use HTTP scraper**
   - Gets profile info âœ…
   - Tries to get videos from HTML states âœ…
   - Tries API (likely fails) âŒ
   - At least user knows what happened

**This is the best approach for your use case!**

---

## ğŸ“ˆ Expected Results by Method

### Playwright with Valid Cookie:
```
âœ… Profile: Casey Kaspol - 7.4M followers, 2221 videos
âœ… Scraped: 2221 videos (all videos)
âœ… Time: 5-10 minutes
```

### HTTP Scraper with Valid Cookie:
```
âœ… Profile: Casey Kaspol - 7.4M followers, 2221 videos
âœ… Scraped: 0-30 videos (from HTML state only)
âš ï¸  API: 0 videos (missing X-Bogus)
âœ… Time: 10-30 seconds
```

### HTTP Scraper without Cookie:
```
âœ… Profile: Casey Kaspol - 7.4M followers, 2221 videos
âŒ Scraped: 0 videos (TikTok blocks video data)
âŒ API: 0 videos
âœ… Time: 5-10 seconds
```

---

## ğŸ”§ Debugging Steps

### 1. Check What Data TikTok Returns

```bash
docker compose exec worker python diagnose_tiktok.py itsceceh
```

Look for:
```
âœ… Found 30 videos in SIGI_STATE ItemModule
```
or
```
âŒ NO VIDEOS FOUND IN HTML
âŒ API RETURNED 0 VIDEOS (missing X-Bogus)
```

### 2. Check Your Cookie

```bash
docker compose exec worker python -c "
from app.config import get_settings
settings = get_settings()
print('Cookie length:', len(settings.tiktok_cookie or ''))
print('Has cookie:', bool(settings.tiktok_cookie))
"
```

### 3. Test Playwright

```bash
docker compose exec worker python test_scraper.py --username tiktok --max-videos 5
```

Should see:
```
âœ… Scraped 5 videos!
```

### 4. Check Debug Files

```bash
# Check if HTML states have videos
docker compose exec worker cat downloads/.debug/itsceceh_universal.json | grep -i itemList
docker compose exec worker cat downloads/.debug/itsceceh_sigi.json | grep -i ItemModule
```

---

## ğŸ“ Summary

| Method | Profile | Videos (HTML) | Videos (API) | Pagination | Reliability |
|--------|---------|---------------|--------------|------------|-------------|
| **Playwright + Cookie** | âœ… | âœ… | âœ… | âœ… | 90-95% |
| **Playwright No Cookie** | âœ… | âŒ | âŒ | âŒ | 10-20% |
| **HTTP + Cookie** | âœ… | âœ… (0-30) | âŒ | âŒ | 40-60% |
| **HTTP No Cookie** | âœ… | âŒ | âŒ | âŒ | 5-10% |

### Bottom Line:

**The X-Bogus signature requirement makes the HTTP scraper API calls impossible without:**
1. Reverse engineering TikTok's obfuscated JavaScript (unsustainable)
2. Using a real browser (Playwright) to generate signatures
3. Paying for third-party services

**Your best bet:** 
- âœ… Use Playwright with a valid cookie
- âœ… HTTP scraper as fallback (gets 0-30 videos from HTML)
- âœ… Clear error messages explaining the limitation

Your current implementation is optimal given these constraints! ğŸ¯
